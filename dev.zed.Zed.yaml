# dev.zed.Zed.yaml
app-id: dev.zed.Zed
runtime: org.freedesktop.Sdk
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: zed
separate-locales: false
finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland

  # Enable access to Flatpak host commands (Needs linter exception: https://docs.flathub.org/docs/for-app-authors/linter#exceptions)
  - --talk-name=org.freedesktop.Flatpak

  # Enable access to Freedesktop Secret Service & related auth services since Zed uses Git heavily
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd6
  - --socket=ssh-auth
  - --socket=gpg-agent
  - --talk-name=org.gnome.keyring.SystemPrompter
cleanup:
  - /share/doc
  - /share/gtk-doc
  - /share/info
  - /share/man
  - '*.a'
  - '*.la'

modules:
  - shared-modules/libsecret/libsecret.json

  # - name: openssl
  #   buildsystem: simple
  #   build-commands:
  #     - ./Configure --prefix=${FLATPAK_DEST} shared enable-fips zlib no-tests
  #     - make
  #     - make install_sw
  #   sources:
  #     - type: archive
  #       url: https://github.com/openssl/openssl/releases/download/openssl-3.2.3/openssl-3.2.3.tar.gz
  #       sha256: 52b5f1c6b8022bc5868c308c54fb77705e702d6c6f4594f99a0df216acf46239

  - name: libssh2
    rm-configure: true
    sources:
      - type: archive
        url: https://www.libssh2.org/download/libssh2-1.11.0.tar.gz
        sha256: 3736161e41e2693324deb38c26cfdc3efe6209d634ba4258db1cecff6a5ad461
        x-checker-data:
          type: anitya
          project-id: 1730
          url-template: https://www.libssh2.org/download/libssh2-$version.tar.gz
      - type: script
        commands:
          - autoreconf -fiv
        dest-filename: autogen.sh

  - name: gcr
    buildsystem: meson
    cleanup:
      - /include
      - /lib/debug
      - /lib/girepository-1.0
      - /lib/pkgconfig
      - /share/gir-1.0
      - /share/pkgconfig
    config-opts:
      - -Dgtk_doc=false
      - -Dintrospection=false
    sources:
      - type: archive
        sha256: bad10f3c553a0e1854649ab59c5b2434da22ca1a54ae6138f1f53961567e1ab7
        url: https://download.gnome.org/sources/gcr/3.41/gcr-3.41.2.tar.xz

  - name: zed
    buildsystem: simple
    build-commands:
      - install -Dm 755 bin/* --target-directory ${FLATPAK_DEST}/bin
      - install -Dm 755 lib/* --target-directory ${FLATPAK_DEST}/lib
      - install -Dm 755 libexec/* --target-directory ${FLATPAK_DEST}/libexec
      - install -Dm 644 share/applications/* --target-directory ${FLATPAK_DEST}/share/applications
      - install -Dm 644 ${FLATPAK_ID}.metainfo.xml --target-directory ${FLATPAK_DEST}/share/metainfo
      - install -Dm 644 share/icons/hicolor/512x512/apps/zed.png --target-directory
        ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps

      # Rename instances of `zed` to `${FLATPAK_ID}`
      - rename zed ${FLATPAK_ID} ${FLATPAK_DEST}/share/{applications/*,icons/hicolor/*/apps/*}

      # Ensure `desktop-file-edit` validates; Enforce `[Desktop Action NewWorkspace]` has a matching action
      - |
        if ! grep -q "^Actions=NewWorkspace" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"; then
          # Find the line number where [Desktop Action NewWorkspace] is located
          line_num=$(grep -n "^\[Desktop Action NewWorkspace\]" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop" | cut -d: -f1)
          if [ -n "$line_num" ]; then
            # Insert Actions=NewWorkspace above the line where [Desktop Action NewWorkspace] is located
            sed -i "${line_num}i Actions=NewWorkspace" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
          else
            # If [Desktop Action NewWorkspace] doesn't exist, add Actions=NewWorkspace at the end
            echo "Actions=NewWorkspace" >> "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
          fi
        fi

      # Modify original `.desktop` file to use the correct icon name
      - desktop-file-edit --set-icon="${FLATPAK_ID}" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: archive
        url: https://github.com/zed-industries/zed/releases/download/v0.154.4/zed-linux-x86_64.tar.gz
        sha256: 0af5b5653c4c0f0e5b580bf222a67581374a3e44ad2d0371b7e43a93ad68a61f
        only-arches:
          - x86_64
        x-checker-data:
          type: json
          url: https://api.github.com/repos/zed-industries/zed/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name=="zed-linux-x86_64.tar.gz") | .browser_download_url
      - type: archive
        url: https://github.com/zed-industries/zed/releases/download/v0.154.4/zed-linux-aarch64.tar.gz
        sha256: dc10ce057148793b0bc80f31172a15fb03c8ea56f61d0768a309378ed2e463b4
        only-arches:
          - aarch64
        x-checker-data:
          type: json
          url: https://api.github.com/repos/zed-industries/zed/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name=="zed-linux-aarch64.tar.gz") | .browser_download_url

      - type: file
        path: dev.zed.Zed.metainfo.xml

  - name: curl
    config-opts:
      - --disable-docs
      - --disable-manual
      - --disable-static
      - --enable-hsts
      - --enable-ipv6
      - --enable-symbol-hiding
      - --enable-threaded-resolver
      - --with-openssl
      - --with-libssh2
    sources:
      - type: archive
        sha256: 73a4b0e99596a09fa5924a4fb7e4b995a85fda0d18a2c02ab9cf134bebce04ee
        url: https://curl.se/download/curl-8.10.1.tar.xz
